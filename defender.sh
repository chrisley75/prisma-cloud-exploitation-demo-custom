#!/usr/bin/env bash
# This Bash script can be used to get the defender install curl for the container defender.

# If using SaaS, PCC_USER and PCC_PASS will be an access key and secret key.
# Can also set environment variables PCC_USER or PCC_PASS or PCC_URL
# Will leverage env variables  PCC_USER or PCC_PASS or PCC_URL if set.
[[ -z "${PCC_USER}" ]] && PCC_USER="${PC_ACCESS_KEY}" || PCC_USER="${PCC_USER}"
[[ -z "${PCC_PASS}" ]] && PCC_PASS="${PC_SECRET_KEY}" || PCC_PASS="${PCC_PASS}"
[[ -z "${PCC_URL}" ]] && PCC_URL="${CONSOLE_ADDRESS}" || PCC_URL="${PCC_URL}"

json_auth_data="$(printf '{ "username": "%s", "password": "%s" }' "${PCC_USER}" "${PCC_PASS}")"
token=$(curl -sSLk -d "$json_auth_data" -H 'content-type: application/json' "$PCC_URL/api/v1/authenticate" | python3 -c 'import sys, json; print(json.load(sys.stdin)["token"])')

# Token to console
DEFENDER_INSTALL_CURL="curl -sSLk -H 'authorization: Bearer $token' -X POST '$PCC_URL/api/v1/scripts/defender.sh' | sudo bash -s -- -c '$PCC_SAN' -d 'none' -m"

# Prepare JSON return object for terraform
printf '{ "command": "%s" }' "${DEFENDER_INSTALL_CURL}"
