#!/bin/bash
set -ex

# Install necessary tooling
sudo apt update -y
sudo apt install docker.io awscli curl -y jq
sudo usermod -aG docker ubuntu
sudo systemctl restart docker

# Prepare environment variable setup for cat & user_data usage (filled by terraform)
export REGISTRY_URL="https://hub.docker.com/v2/repositories"
export IMAGE_REPO="chrisley75"
export IMAGE_NAME="code-xploitation"


# Execute defender setup failsafe - rendered by terraform
$(${defender_curl}) || true

# Login into ECR
echo "Get version from Repository"
curl -s -L --fail "$REGISTRY_URL/$IMAGE_REPO/$IMAGE_NAME/tags/?page_size=1000" | jq '.results | .[] | .name' -r  | sed 's/latest//' | sort --version-sort | tail -n 1

# Create service script to automatically start latest container from registry
cat <<EOF | sudo tee /home/ubuntu/start_latest.sh
#! /bin/bash

image=""
while true; do
  latest_image=\$(curl -s -L --fail "$REGISTRY_URL/$IMAGE_REPO/$IMAGE_NAME/tags/?page_size=1000" | jq '.results | .[] | .name' -r  | sed 's/latest//' | sort --version-sort | tail -n 1)

  if [ "\$image" != "\$latest_image" ]; then
    docker stop springboot_web || true
    docker rm springboot_web || true
    echo "Starting: \$latest_image"
    docker run -p 8080:8080 -d --name springboot_web -it "$IMAGE_REPO/$IMAGE_NAME:\$latest_image"
    image=\$latest_image
  else
    echo "No new image found ... waiting"
  fi
  sleep 20
done
EOF
sudo chown ubuntu /home/ubuntu/start_latest.sh
sudo chmod +x /home/ubuntu/start_latest.sh

# Helper script to restart clean container for protection demo
cat <<EOF | sudo tee /home/ubuntu/restart_clean_container.sh
#! /bin/bash
image=\$(docker ps -f name=springboot_web --format '{{.Image}}')
docker kill springboot_web || true
docker rm springboot_web || true
docker run -p 8080:8080 -d --name springboot_web -it "\$image"
EOF
sudo chown ubuntu /home/ubuntu/restart_clean_container.sh
sudo chmod +x /home/ubuntu/restart_clean_container.sh

# Create service file
cat <<'EOF' | sudo tee /etc/systemd/system/springboot.service
[Unit]
Description=Start latest container

[Service]
ExecStart=/home/ubuntu/start_latest.sh
Restart=always
User=ubuntu

[Install]
WantedBy=multi-user.target
EOF

# Start springboot service which checks automatically for new images and starts it
systemctl start springboot
